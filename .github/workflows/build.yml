name: Kingfall Final Injection

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: âš¡ï¸ Check Source Icon
        run: |
          # å¯»æ‰¾æ ¹ç›®å½•å›¾æ ‡
          SOURCE_ICON=$(find . -maxdepth 1 -iname "icon.png" -o -iname "icon.jpg" -o -iname "icon.jpeg" | head -n 1)
          if [ -z "$SOURCE_ICON" ]; then
            echo "ğŸ›‘ é”™è¯¯ï¼šæ²¡æ‰¾åˆ° icon.pngï¼è¯·ç¡®è®¤æ–‡ä»¶å·²ä¸Šä¼ ï¼"
            ls -la
            exit 1
          fi
          echo "âœ… é”å®šæºå›¾æ ‡: $SOURCE_ICON"
          # ä¿å­˜æºå›¾æ ‡è·¯å¾„ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "SOURCE_ICON_PATH=$SOURCE_ICON" >> $GITHUB_ENV

      - name: Build Xcode Project
        run: |
          PROJECT_FILE=$(find . -maxdepth 2 -name "*.xcodeproj" | head -n 1)
          PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
          SCHEME_NAME="$PROJECT_NAME"
          
          # ç”ŸæˆéšæœºID
          RANDOM_ID="com.fangyikai.app.$(date +%s)"
          
          # æ„å»º (æ³¨æ„ï¼šè¿™é‡Œæ„å»ºå‡ºæ¥çš„åŒ…å¯èƒ½æ²¡æœ‰å›¾æ ‡ï¼Œæ²¡å…³ç³»ï¼Œä¸‹é¢æˆ‘ä»¬ä¼šå¼ºè¡Œå¡è¿›å»)
          xcodebuild clean -project "$PROJECT_NAME.xcodeproj" -scheme "$SCHEME_NAME" -configuration Release
          
          xcodebuild build \
            -project "$PROJECT_NAME.xcodeproj" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -derivedDataPath build \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            PRODUCT_BUNDLE_IDENTIFIER="$RANDOM_ID"

      - name: ğŸ’‰ Inject Icons & Package IPA
        run: |
          # 1. æ‰¾åˆ°æ„å»ºå¥½çš„ App æ–‡ä»¶å¤¹
          RAW_APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" | head -n 1)
          if [ -z "$RAW_APP_PATH" ]; then
             echo "âŒ æ„å»ºå¤±è´¥ï¼Œæ‰¾ä¸åˆ° .app"
             exit 1
          fi
          echo "ğŸ“¦ ç›®æ ‡ App è·¯å¾„: $RAW_APP_PATH"

          # 2. å‡†å¤‡ payload æ–‡ä»¶å¤¹
          mkdir Payload
          # å¤åˆ¶ App åˆ° Payloadï¼ŒåŒæ—¶æ”¹åä¸ºè‹±æ–‡ FangYiKai.app (é˜²æ­¢SideStoreæŠ¥é”™)
          cp -R "$RAW_APP_PATH" Payload/FangYiKai.app

          # 3. ã€æš´åŠ›æ¤å…¥ã€‘ç›´æ¥åœ¨ Payload/FangYiKai.app é‡Œé¢ç”Ÿæˆå›¾ç‰‡
          # è¿™ä¸€æ­¥ç»•è¿‡äº† Xcodeï¼Œç›´æ¥å†™æ–‡ä»¶
          TARGET_DIR="Payload/FangYiKai.app"
          SRC="${{ env.SOURCE_ICON_PATH }}"
          
          echo "ğŸ’‰ æ­£åœ¨å°†å›¾æ ‡å¼ºè¡Œæ¤å…¥åˆ°: $TARGET_DIR"
          
          # ç”Ÿæˆ Info.plist é‡ŒæŒ‡å®šçš„ filenames
          # AppIcon-60@2x.png (120x120) - iPhone
          sips -Z 120 "$SRC" --out "$TARGET_DIR/AppIcon-60@2x.png"
          # AppIcon-60@3x.png (180x180) - iPhone Plus/Max
          sips -Z 180 "$SRC" --out "$TARGET_DIR/AppIcon-60@3x.png"
          # AppIcon-76@2x.png (152x152) - iPad
          sips -Z 152 "$SRC" --out "$TARGET_DIR/AppIcon-76@2x.png"
          # AppIcon-83.5@2x.png (167x167) - iPad Pro
          sips -Z 167 "$SRC" --out "$TARGET_DIR/AppIcon-83.5@2x.png"
          
          # å†åšä¸€ä¸ª Icon.png å…œåº•
          sips -Z 57 "$SRC" --out "$TARGET_DIR/Icon.png"
          sips -Z 114 "$SRC" --out "$TARGET_DIR/Icon@2x.png"

          # 4. éªŒè¯ä½“ç§¯ (è°ƒè¯•ç”¨)
          echo "ğŸ“Š æ£€æŸ¥æ¤å…¥åçš„å›¾æ ‡æ–‡ä»¶ï¼š"
          ls -lh "$TARGET_DIR" | grep "png"

          # 5. æ‰“åŒ…
          # ä½¿ç”¨ -ry å‚æ•°ä¿ç•™è½¯è¿æ¥ï¼Œç¡®ä¿ç»“æ„å®‰å…¨
          zip -ry "FangYiKai_DirectInject.ipa" Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: FangYiKai_DirectInject_IPA
          path: ./*.ipa
